<!DOCTYPE html>
<html>
  <head>
    <title>Language experiment</title>
    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.1"></script>

    <link href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="timerstyle.css" rel="stylesheet" type="text/css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src = "timer.js"></script> 

  </head>
  <body>
    <div id="app"></div>
    <div id="jspsych-target"></div>
    
    <script>

// should be window.jsPsych (instead of var) if running in cognition.run
var jsPsych = initJsPsych({
  display_element: 'jspsych-target',
      on_finish: function() {
        jsPsych.data.displayData();
      },
      on_trial_start: function(trial) {
        jsPsych.data.addProperties({subject: subject_id});
      }
    });

//enables sequence of events in experiment 
var timeline = [];
  
//creates random subject number 
var subject_id = Math.floor(Math.random()*100000);

//formats opening instruction page and tells participant about experiment
var maininstructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
  <p style="font-size:20px;"> Thank you for taking part in this experiment!</p>
  <p style="font-size:20px;"> ‎</p>
  <p style="font-size:22px;"> <strong>This experiment has two tasks:</strong></p>
  <p style="font-size:18px;"> <u>In the first task</u>, you will be presented the name of a category and must type 
  <p style="font-size:18px;"> in as many items that correspond to that category as you can within the time limit. </p>
  <p style="font-size:18px;"> <u>In the second task</u>, you will move each of the words that you typed in the first </p>
  <p style="font-size:18px;"> task around so that the similar ones are proportionately closer together.</p>
  <p style="font-size:18px;"> The experiment will consist of only 3 "trials," so please be as accurate/precise as 
  <p style="font-size:18px;"> possible when typing in items and placing the objects, rather than trying to speed through.</p>
  <p style="font-size:20px;"> ‎</p>
  <p style="font-size:18px;"> Before you get started, we just want to get you familiar with the experiment layout. We'll walk you through</p>
  <p style="font-size:18px;"> a practice verbal fluency and spatial arrangement task and provide more detailed instructions.</p>


  <p style="font-size:18px;"> When you are ready to start, <strong>press Continue.</strong></p>

  `,
  choices: ["Continue"],
  on_load: function() {
    clearInterval(timerInterval);
    resetCountdown();
    jsPsych.pluginAPI.clearAllTimeouts();

  },
      data: {
        typeoftrial: 'instructions',
        subject: subject_id
    }
};    

//instructs participants on VFT task with video example
var VFTInstructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
  <p style="font-size:22px;"><strong>You are about to perform a verbal fluency task.</strong></p>
  <p style="font-size:17px;"> In this task, you will be presented the name of a category (e.g., FURNITURE) in capital</p>
  <p style="font-size:17px;"> letters. Your job is to type in as many items as you can think of that correspond to that</p>
  <p style="font-size:17px;"> category in 3 minutes. You will be doing this three times on three separate domains.</p> 
  

  <video width = "600" height = "300" autoplay muted loop style = "margin-top: 10px;">
    <source src = "VFTTutorial.mp4" type = "video/mp4">
  </video>

  <p style="font-size:17px;"> After you type in each word, press <strong>ENTER</strong> to type in the next </p>
  <p style="font-size:17px;"> word. When the timer runs out, you will automatically proceed to the next task.</p>

  <p style="font-size:17px;"> When you're ready, <strong>press Begin</strong> to practice! For the practice trial,</p>
  <p style="font-size:17px;"> you will be given 1 minute, but remember you will be given 3 minutes for the real task.</p> 
  `,
  choices: ["Begin"],
  on_load: function() {
    clearInterval(timerInterval);
    resetCountdown();
    jsPsych.pluginAPI.clearAllTimeouts();

  },
      data: {
        typeoftrial: 'instructions',
        subject: subject_id
    }
};    

//instructs participants on SpAM task with video example
var SpAMInstructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
  <p style="font-size:22px;"> <strong>Now, you will begin a spatial arrangement task.</strong></p>
  <p style="font-size:17px;"> In this task, you will be shown the set of words you typed in the last verbal fluency task you performed.</p>
  <p style="font-size:17px;"> We need to know how similar you think these words are to one another. Your job is to move each word</p>
  <p style="font-size:17px;"> around so that the similar words are proportionately closer together. That is, you should move them into</p>
  <p style="font-size:17px;"> space such that the distance between each pair of items represents how similar you think the pair is.</p>
  <p style="font-size:17px;"> (with closer in space meaning more similar, and farther away in space meaning more dissimilar)</p>

  <video width = "600" height = "400" autoplay muted loop style = "margin-top: 10px;">
    <source src = "SpAMTutorial.mp4" type = "video/mp4">
  </video>

  <p style="font-size:17px;"> The words will appear one by one in the top left corner of a box. You can move the words by simply</p>
  <p style="font-size:17px;"> click/dragging them. If the words seem similar, place them close together. If they seem dissimilar,</p>
  <p style="font-size:17px;"> place them farther away from each other. You will be doing this three times on three separate domains,</p> 
  <p style="font-size:17px;"> with a different set of words each time, based the words you typed in the corresponding verbal fluency </p>
  <p style="font-size:17px;"> task. After dragging each word, the next word will appear. You may rearrange previously placed items.</p>
  <p style="font-size:17px;"> Note, to complete the trial, <u>all items</u> must be moved into the "active arena," the large central box. </p>
  <p style="font-size:17px;"> When you are finished arranging the space, click on the little Continue button at the bottom of the screen.</p>
  
    <p style="font-size:5px;"> ‎</p>

  <p style="font-size:17px;"> Let's continue with our practice round!</p>
  <p style="font-size:17px;"> When you're ready, <strong>press Begin.</strong></p>

  `,
  choices: ["Begin"],
      data: {
        typeoftrial: 'instructions',
        subject: subject_id
    }
};    

//instructs participant after they complete the practice round
var startInstructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
  <p style="font-size:20px;">You have completed the practice round!</p>
  <p style="font-size:18x;"> Now, you will begin the actual task, consisting of three rounds with different categories.</p>
  <p style="font-size:18x;"> Again, your first task is to first type in as many items as you can think of that correspond to the given category</p>
  <p style="font-size:18x;"> within the time limit. Then, you will arrange the items you input previously in the box provided based on how related they are.</p>

  <p style="font-size:10px;"> ‎</p>
  <p style="font-size:18px;"> When you're ready, <strong>press Begin</strong> to start the verbal fluency task.</p>
  `,
  choices: ["Begin"],
      data: {
        typeoftrial: 'instructions',
        subject: subject_id
    }
};    

//provides reminder of instructions between VFT task and SpAM
var betweenVFTAndSpAMInstructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
  <p style="font-size:20px;"> <strong>You are moving to the spatial arrangement task.</strong></p>
  <p style="font-size:16px;"> As a reminder, in this task, you will be shown a set of words.</p>
  <p style="font-size:16px;"> We need to know how similar you think these words are to one another.</p>
  <p style="font-size:16px;"> To indicate your perception of similarity, you will move each word</p> 
  <p style="font-size:16px;"> around so that the similar ones are proportionately closer together.</p>
  <p style="font-size:16px;"> If the words seem similar, place them close together, if they seem</p>
  <p style="font-size:16px;"> dissimilar, place them farther away from each other.</p>
  <p style="font-size:10px;"> ‎</p>
  <p style="font-size:18px;"> Press <strong>Begin</strong> to start.</p>

  `,
  choices: ["Begin"],
      data: {
        typeoftrial: 'instructions',
        subject: subject_id
    }
};    

//provides reminder of instructions for next VFT category
var afterSpAMInstructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
  <p style="font-size:18px;"> <strong>You will now move to the next category.</strong></p>
  <p style="font-size:16px;"> As a reminder, in this task, you will type as many words as you can </p> 
  <p style="font-size:16px;"> think of that correspond to the category presented in capital letters.</p>
  <p style="font-size:18px;"> Press <strong>Begin</strong> to start.</p>

  `,
  choices: ["Begin"],
      data: {
        typeoftrial: 'instructions',
        subject: subject_id
    }
};    

window.responseData = {};

//tracks responses and reaction time, adding each to a seperate array
function createResponseHandler(domain) {
  return function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        const currentInput = document.activeElement;

      if (
        currentInput.classList.contains(`${domain}-response`) && 
        currentInput.value.trim() !==""
      ) {
        const timeElapsed = Number((performance.now()- responseData[domain].startTime).toFixed(2));
        
        responseData[domain].responses.push(currentInput.value.trim());
        responseData[domain].times.push(timeElapsed)

        currentInput.disabled = true;
        currentInput.classList.remove("active");

        const newInput = document.createElement("input");
        newInput.type = "text";
        newInput.className = `${domain}-response active`;
        document.getElementById("responses").appendChild(newInput);
        newInput.focus();
      }
    }
  };
}

//formats VFT and maps tag and response time to each item input 
function VFTTask(domain, prompt, time = 10000) {
  const className = `${domain}-response`;
  const responseHandler = createResponseHandler(domain);
  
  return {
  type: jsPsychHtmlKeyboardResponse,
  data: {
    task: "VFT",
    domain: domain,
    subject: subject_id
  },
  
  stimulus:`
    <div id = "timer-box"></div>
    <div id = "response-input-box">
      <p style = "font-size:30px;">${prompt}</p>
      <div id = "responses">
        <input type = "text" class = "${className} active" autofocus />
      </div>
      <p id = "below-input-text" style = "font-size: 14px; margin-top: 10px; color: gray; text-align: left;"> press <strong>enter</strong> after each word!</p>
    </div>
    <style>
      #responses {
      position: relative;
      width: 300px;
      height: 40px; 
      }

      .${className} {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        font-size: 20px;
        padding: 5px;
        box-sizing: border-box;
        opacity: 0.5;
      } 

      .${className}.active {
      opacity: 1;
      z-index: 999;
      }
    </style>
    `,

  choices: [],
  trial_duration: time, 
  response_ends_trial: false,

  on_load: function () {
    clearInterval(timerInterval);
    resetCountdown();
    countDown(time);
    
    responseData[domain]= {
      responses: [],
      times: [],
      interitem_intervals: [],
      startTime: performance.now()
    };

    document.addEventListener ("keydown", responseHandler);
    document.querySelector(`.${className}.active`)?.focus();
  },

  on_finish: function(data) {
    document.removeEventListener("keydown", responseHandler);
   
    const responses = responseData[domain].responses;

    function responseTags(responses) {
      return responses.map((word, index) => ({
        response: word,
        tag: index + 1
      }))
    }

    const taggedResponses = responseTags(responses);
    const times = responseData[domain].times;

    const firstResponseThenIntervals = times.length > 0
      ? [times[0], ...times.slice(1).map((time, i) => time - times[i])]
      : [];

    const roundedResponseIntervals = firstResponseThenIntervals.map(t => Number(t.toFixed(2)));

      
      data.tagged_responses = JSON.stringify(taggedResponses);
      data.response_times = JSON.stringify(roundedResponseIntervals)
  
    
    clearInterval(timerInterval);
    }
  };  
}

timeline.push({
  type: jsPsychCallFunction,
  func: () => {
    console.log("All Data:", jsPsych.data.get().values());
  }
});

//handles case where no words are input 
function VFTRedo(domain, prompt, time = 10000) {
  const VFTTrial = VFTTask(domain, prompt, time);
  
  return {
    timeline: [VFTTrial],
    loop_function: function() {
      const trialData = jsPsych.data.get().filter({
        task: "VFT",
        domain: domain
      }).last(1).values()[0];
      let responses = [];

      try {
        responses = JSON.parse(trialData?.tagged_responses || "[]");
      } catch (e) {
        console.error("Error parsing tagged_responses:", e);
    }

      if (responses.length === 0) {
        alert("You did not input any responses. Please try again.");
        return true;
      }
      return false;
    }
  };
}

//creates SpAM task by gathering VFT responses and tracking item movement/coordinates
function SpamTask(domain) {
  return {
    type: jsPsychHtmlButtonResponse,
    stimulus: function() {
      let html = `
        <p style="font-size:20px;">Arrange each word to the drop box below based on how related they are to one another.</p> 
        <p style="font-size:18px;">A new word will appear after <strong>each word</strong> you move.</p>
        <p style="font-size:17px;"> When you are finished arranging the space, click on the little Continue button at the bottom of the screen.</p>
       <div id="word-drop-area" style="
            margin: 40px auto;
            width: 80vw;
            max-width: 1400px;
            height: 55vh;
            min-height: 500px;
            max-height: 750px;
            border: 2px solid #aaa;
            padding: 20px;
            position: relative;
          "></div>


          <p style="font-size:14px; color: gray;">Remember, previously placed words can be rearranged if needed!</p>
          <style>       
            .draggable {
              display: inline-block;
              background: #eef;
              padding: 4px 8px;
              border: 1px solid #aaa;
              border-radius: 4px;
              cursor: grab;
              font-size: 14px;
              line-height: 1.2;
              margin-bottom: 4px;
            }

        </style>    
      `;
        return html;
  },
  
  choices: ["Continue"], 
  button_html: `
  <button 
    class="jspsych-btn" 
    id="continue-button" 
    style="
      display: none;
      margin-top: 20px;
      background-color: #2e9f5e;
      color: white;
      font-size: 18px;
      font-weight: 600;
      padding: 12px 28px;
      border: none;
      border-radius: 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
    ">
    %choice%
  </button>
`,
  data: {
    task: "SpAM",
    domain: domain,
    subject: subject_id
  },
  
  on_load: function() {
    const VFTResponses = jsPsych.data.get().filter({ task: "VFT", domain: domain }).last(1).values()[0];
    const domainWords = JSON.parse(VFTResponses.tagged_responses || "[]");
    const WordDropArea = document.getElementById("word-drop-area");
    let currentIndex = 0;
    window.WordsDropped = [];

    //allows dragging and tracks mouse press onto a word (or rectangle the word is in)
    function Draggable(element, onFirstMove) {
      let offsetX, offsetY;
      let currentlyDragging = false;
      let hasMoved = false;
    
      element.addEventListener("mousedown", (event) => {
        currentlyDragging = true;
        const rectangle = element.getBoundingClientRect();
        offsetX = event.clientX - rectangle.left;
        offsetY = event.clientY - rectangle.top;
        element.style.cursor = "grabbing";

        document.addEventListener("mousemove", OnMouseMove);
        document.addEventListener("mouseup", OnMouseUp);

        event.preventDefault();
      });

      //tracks mouse movement of the rectangle the word is in and calculates where it moves
      function OnMouseMove (event) {
        if (!currentlyDragging) return;

        const dropRectangle = WordDropArea.getBoundingClientRect();
        let left = event.clientX - dropRectangle.left - offsetX;
        let top = event.clientY - dropRectangle.top - offsetY;

        left = Math.max(0, Math.min(left, dropRectangle.width - element.offsetWidth));
        top = Math.max(0, Math.min(top, dropRectangle.height - element.offsetHeight));

        element.style.left = left + "px"
        element.style.top = top + "px"
    
        if (!hasMoved) {
          hasMoved = true
          if (typeof onFirstMove === "function") {
            onFirstMove();
          }
        }
      }
      
      //tracks when mouse is no longer pressing on word box and records words positions
      function OnMouseUp () {
        if (currentlyDragging) {
          currentlyDragging = false;
          element.style.cursor = "grab";
          document.removeEventListener("mousemove", OnMouseMove)
          document.removeEventListener("mouseup", OnMouseUp)

          // window.WordsDropped.push({
          //   word: element.textContent,
          //   id: element.id,
          //   left: element.style.left,
          //   top: element.style.top
          // });

          const dropRect = WordDropArea.getBoundingClientRect();
          const elemRect = element.getBoundingClientRect();

          // position of element *within drop area*
          const x_px = elemRect.left - dropRect.left;
          const y_px = elemRect.top - dropRect.top;

          // normalized coordinates (0–1)
          const x_norm = x_px / (dropRect.width - elemRect.width);
          const y_norm = y_px / (dropRect.height - elemRect.height);

          window.WordsDropped.push({
            word: element.textContent,
            id: element.id,

            // raw pixel values (optional, for debugging)
            x_px: x_px,
            y_px: y_px,

            // normalized coordinates (USE THESE FOR ANALYSIS)
            x_norm: x_norm,
            y_norm: y_norm,

            // canvas size at time of drop (important metadata)
            canvas_width: dropRect.width,
            canvas_height: dropRect.height
          });

          
          if (window.WordsDropped.length === domainWords.length) {
            const button = document.getElementById("continue-button");
            if (button) button.style.display = "inline-block";
          }

        }
      }
    }
      //handles the display of the next word by establishing placement and calling next index of animal VFT responses
      function NextWord() {
      if (currentIndex >= domainWords.length) return;

      const words = domainWords[currentIndex];
      const wordDiv = document.createElement("div");
      wordDiv.textContent = words.response;
      wordDiv.className = "draggable";
      wordDiv.id = `word-${words.tag}`;
      wordDiv.style.position = "absolute";
      wordDiv.style.left = "20px";
      wordDiv.style.top = "20px"
      
      WordDropArea.appendChild(wordDiv);
      Draggable(wordDiv, () => {
        currentIndex ++; 
        setTimeout(() => {
          NextWord(); 
        }, 2000); //2 second delay before next box appears
      });
    }

    NextWord();
  },  

  on_finish: function (data) {
      data.droppedwords = window.WordsDropped || [];
      data.viewport_width = window.innerWidth;
      data.viewport_height = window.innerHeight;
      data.device_pixel_ratio = window.devicePixelRatio;

    }
  };
}


  var endexperiment = {
    //on_load: resetCountdown,
      type: jsPsychHtmlButtonResponse,
      stimulus: `
      <p>You have completed the experiment. Thank you for participating! </p>
      <p> Please click <a href="https://drive.google.com/file/d/1yD8wzNc2l6z4PzHAHSpVsnpay0790VCZ/view" target="_blank" rel="noopener noreferrer">here</a> to access the debriefing form and know more about our research.</p>
      <p> Please click the button below to finish the experiment and save your data.</p>
      <p> IMPORTANT: Please do not leave this page without clicking the button below.</p>
        `,
      choices: ['Finish and Save Data'],
      button_html: '<button class="jspsych-btn">%choice%</button>',
      data: {
        typeoftrial: "end"
      }
  };

  // demographics
var demographics_intro = {
        type: jsPsychInstructions,
        pages: [
            '<br><br><br>The experiment is now complete! We will now ask you a short series of demographics questions. <br><br> While some questions are required (*), you may skip any others you do not wish to answer. <br><br>Aftering filling out your responses, you may press CONTINUE to advance to the next page.'
        ],
        show_clickable_nav: true
    }

var demographics_survey1 = {
        type: jsPsychSurveyHtmlForm,
        preamble: "<h2><br><br><br>Demographics Questionnaire</h2>", name: 'heading', rows: 1, columns: 50,
        html: `
        <label for="gender">What is your gender?</label>
        <input type="text" id="gender" name="gender" required><br><br>
        
        <label for="age">What is your age?</label>
        <input type="number" id="age" name="age" min="0" max="120" required><br><br>

        <label for="education">How many years of formal education have you had? (consider graduating high school to be 12 years)</label>
        <input type="number" id="education" name="education" min="0" max="120" required><br><br>
    `,
        data: {
            typeoftrial: 'demographics',
        },
        on_finish: function(data){

            data.age = data.response.age
            data.gender = data.response.gender
            data.education = data.response.education
            
        }
    };
        
    var demographics_survey2 = {  
    type: jsPsychSurveyMultiSelect,
    preamble: "<h2><br><br><br>Demographics Questionnaire</h2>", name: 'heading', rows: 1, columns: 50,
    questions: [  
        {
            prompt: "Please select all the racial categories that apply to you:",
            name: 'race',
            options: ['American Indian/Alaskan Native', 'Asian','Black/African American', 'Native Hawaiian or Other Pacific Islander', 'White/Caucasian', 'Other'
            ],
            required: true,
            is_multiple: true 
        },
    ],
    data: {
        typeoftrial: 'demographics',
    },
    on_finish: function(data){
        data.race = data.response.race
        // if length of data.race is more than 1, then replace race with "multiracial"
        if(data.race.length > 1){
          data.race = "multiracial"
      }
      else{
        data.race = data.race[0]
      }
    }
    };

    var demographics_survey3 = {  
    type: jsPsychSurveyMultiChoice,
    preamble: "<h2><br><br><br>Demographics Questionnaire</h2>", name: 'heading', rows: 1, columns: 50,
    questions: [
        {
            prompt: "Are you of Hispanic, Latino/a/x or of Spanish origin?",
            name: 'hispanic',
            options: ['Yes', 'No'],
        },
        {
            prompt: "What is your dominant hand?",
            name: 'dominant_hand',
            options: ['Right', 'Left', 'Ambidextrous'],
        },
        {
            prompt: "Please indicate what time of the day you feel most alert:",
            name: 'alert_time',
            options: ['Morning', 'Afternoon', 'Evening', 'No differences'],
        },
    ],
    data: {
        typeoftrial: 'demographics',
    },
    on_finish: function(data){
        data.hispanic = data.response.hispanic
        data.dominant_hand = data.response.dominant_hand
        data.alert_time = data.response.alert_time
    }
    };


    var demographics_survey4 = {  
    type: jsPsychHtmlButtonResponse,
    preamble: "<h2><br><br><br>Demographics Questionnaire</h2>", name: 'heading', rows: 1, columns: 50,
    stimulus: "<br><br><br>Is English your first language?",
    choices: ['Yes','No'],

    data: {
        typeoftrial: 'demographics',
    },
    on_finish: function(data){
        if(data.response == 0){data.english = "yes"}
        else{data.english = "no"}
    }
    };


var additional_info_question = {
    type: jsPsychSurveyText,
    questions: [
        {prompt: "<br><br><br>Is there anything else we should know about, which might have affected your performance during the experiment? (e.g., lack of sleep, feeling ill etc.)", name: 'additional_info'}
    ],
    data: {
        typeoftrial: 'demographics'
    },
    on_finish: function(data){
        data.other_info = data.response.additional_info
    }
};

var follow_up_questions = {
  type: jsPsychSurveyHtmlForm,
  preamble: "<h2><br><br><br>Demographics Questionnaire</h2>", name: 'heading', rows: 1, columns: 50,
  preamble: "<br><br><br>You indicated that English is not your first language. Please answer the following questions:<br><br>",
  html: `
    <label for="first_language_detail">What is your first language?</label>
    <input type="text" id="first_language" name="first_language" required><br><br>
    
    <label for="age_learned_english">At what age did you learn English?</label>
    <input type="number" id="age_learned_english" name="age_learned_english" min="0" max="120" required><br><br>
  `,
  data: {
        typeoftrial: 'follow_up_demographics'
    },
    on_finish: function(data){
        data.first_language = data.response.first_language
        data.age_learned_english = data.response.age_learned_english
    }
};

var follow_up_procedure = {
        timeline: [follow_up_questions],
    conditional_function: function() {
        var lastTrialData = jsPsych.data.get().last(1).values()[0];
        //console.log("lastTrialData=",lastTrialData)
        return lastTrialData.response === 1;
    }
};


var demographics = {
    timeline: [demographics_intro, demographics_survey1, demographics_survey2, demographics_survey3, demographics_survey4, follow_up_procedure]
};

var save_data = {
    type: jsPsychCallFunction,
    func: function(){saveData(subject_id+".csv",
      jsPsych.data.get().csv())}
  }


function saveData(filename, filedata){
  	$.ajax({
  		type:'post',
  		cache: false,
  		url: 'save_data.php', // this is the path to the above PHP script
      //url: https://script.google.com/macros/s/AKfycbzV--xTooSkBLufMs4AnrCTdwZxVNtycTE4JNtaCze2UijXAg8/exec
  		data: {filename: filename, filedata: filedata}})
  };

  timeline.push(maininstructions);
    timeline.push(
    VFTInstructions,
    VFTRedo("furniture-practice", "Name as many items of <strong>FURNITURE</strong> as you can.", 10000),
    SpAMInstructions,
    SpamTask("furniture-practice")
  );
  timeline.push(startInstructions);

//randomizes trials 
function randomize(array) {
  for (let index = array.length - 1; index > 0; index--) {
    const randomindex = Math.floor(Math.random() * (index + 1));
    [array[index], array[randomindex]] = [array[randomindex], array[index]]
  }
}

const trials = [
  
  [
    VFTRedo("animals", "Name as many <strong>ANIMALS</strong> as you can.", 10000),
    betweenVFTAndSpAMInstructions,
    SpamTask("animals"),
  ],
  // [
  //   VFTRedo("foods", "Name as many <strong>FOODS</strong> as you can.", 10000),
  //   betweenVFTAndSpAMInstructions,
  //   SpamTask("foods"),
  // ],
];

  randomize(trials);
  trials.forEach((block, index) => {

    if (index < trials.length - 1) {
      block.push(afterSpAMInstructions)
    }
    timeline.push(...block);
  });
  timeline.push(demographics);
  timeline.push(save_data);
  timeline.push(endexperiment);

  jsPsych.run(timeline);


    </script>
  </body>
</html>